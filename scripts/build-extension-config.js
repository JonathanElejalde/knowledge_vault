/**
 * Reads an env file from repo root and writes:
 * - extension/lib/env.generated.js (API_BASE_URL, FRONTEND_BASE_URL)
 * - extension/styles/tokens/* and extension/styles/tokens.generated.css
 * from frontend/src/styles/* token sources.
 * Run from repo root before packaging the extension.
 *
 * Usage: node scripts/build-extension-config.js [env-file]
 *   env-file: optional path from repo root (default: .env)
 *   Example for production: node scripts/build-extension-config.js .env.production
 *   Or: ENV_FILE=.env.production node scripts/build-extension-config.js
 * Requires: VITE_API_URL and VITE_APP_BASE_URL (or EXTENSION_*) in the chosen env file or process.env.
 */

const fs = require("fs");
const path = require("path");

const rootDir = path.resolve(__dirname, "..");
const envFile = process.env.ENV_FILE || process.argv[2] || ".env";
const envPath = path.isAbsolute(envFile) ? envFile : path.join(rootDir, envFile);
const outPath = path.join(rootDir, "extension", "lib", "env.generated.js");
const frontendStylesDir = path.join(rootDir, "frontend", "src", "styles");
const extensionStylesDir = path.join(rootDir, "extension", "styles");

const DEFAULT_API = "http://localhost:8000/api/v1";
const DEFAULT_FRONTEND = "http://localhost:5173";

function parseEnv(envPath) {
  const out = {};
  if (!fs.existsSync(envPath)) return out;
  const content = fs.readFileSync(envPath, "utf8");
  for (const line of content.split("\n")) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith("#")) continue;
    const eq = trimmed.indexOf("=");
    if (eq === -1) continue;
    const key = trimmed.slice(0, eq).trim();
    let value = trimmed.slice(eq + 1).trim();
    if ((value.startsWith('"') && value.endsWith('"')) || (value.startsWith("'") && value.endsWith("'"))) {
      value = value.slice(1, -1);
    }
    out[key] = value;
  }
  return out;
}

const env = { ...process.env, ...parseEnv(envPath) };
const apiBase = (env.VITE_API_URL || env.EXTENSION_API_BASE_URL || "").trim() || DEFAULT_API;
const frontendBase = (env.VITE_APP_BASE_URL || env.EXTENSION_FRONTEND_BASE_URL || "").trim() || DEFAULT_FRONTEND;

const content = `/**
 * Generated by scripts/build-extension-config.js from env. Do not edit by hand.
 */
export const API_BASE_URL = ${JSON.stringify(apiBase)};
export const FRONTEND_BASE_URL = ${JSON.stringify(frontendBase)};
`;

fs.mkdirSync(path.dirname(outPath), { recursive: true });
fs.writeFileSync(outPath, content, "utf8");

function syncExtensionTokens() {
  const mappings = [
    {
      source: path.join(frontendStylesDir, "tokens", "colors.css"),
      target: path.join(extensionStylesDir, "tokens", "colors.css"),
    },
    {
      source: path.join(frontendStylesDir, "tokens", "spacing.css"),
      target: path.join(extensionStylesDir, "tokens", "spacing.css"),
    },
    {
      source: path.join(frontendStylesDir, "tokens", "typography.css"),
      target: path.join(extensionStylesDir, "tokens", "typography.css"),
    },
    {
      source: path.join(frontendStylesDir, "tokens", "animations.css"),
      target: path.join(extensionStylesDir, "tokens", "animations.css"),
    },
    {
      source: path.join(frontendStylesDir, "presets.css"),
      target: path.join(extensionStylesDir, "presets.css"),
    },
  ];

  mappings.forEach(({ source, target }) => {
    if (!fs.existsSync(source)) {
      throw new Error(`Token source not found: ${source}`);
    }

    const fileContent = fs.readFileSync(source, "utf8");
    const generated = `/**
 * Generated by scripts/build-extension-config.js.
 * Source: ${path.relative(rootDir, source)}
 * Do not edit by hand.
 */
\n${fileContent}`;

    fs.mkdirSync(path.dirname(target), { recursive: true });
    fs.writeFileSync(target, generated, "utf8");
  });

  const bundlePath = path.join(extensionStylesDir, "tokens.generated.css");
  const bundleContent = `/**
 * Generated by scripts/build-extension-config.js from frontend design tokens.
 * Do not edit by hand.
 */

@import "./tokens/colors.css";
@import "./tokens/spacing.css";
@import "./tokens/typography.css";
@import "./tokens/animations.css";
@import "./presets.css";
`;
  fs.writeFileSync(bundlePath, bundleContent, "utf8");
}

syncExtensionTokens();
console.log("Wrote extension/lib/env.generated.js (API_BASE_URL, FRONTEND_BASE_URL)");
console.log("  Env file:", envPath);
console.log("  API:", apiBase);
console.log("  Frontend:", frontendBase);
console.log("Synced extension design tokens from frontend/src/styles");
